//------------------------------------------------------------------------------
// includes
//------------------------------------------------------------------------------
#include <readline/readline.h>
#include <readline/history.h>
#include <iostream>

#include "Terminal.hpp"

//------------------------------------------------------------------------------
// Functions
//------------------------------------------------------------------------------
char ** search_completion(const char * text, int start, int end);

//==============================================================================
//
// Cst / Dst
//
//==============================================================================
//------------------------------------------------------------------------------
// Cst
//------------------------------------------------------------------------------
Terminal::Terminal() :
    _again(true),
    _prompt(""),
    _name("dominus_monitor_cmd")
{
    init_completion();
}

//==============================================================================
//
// Public methods
//
//==============================================================================
//------------------------------------------------------------------------------
// run
//------------------------------------------------------------------------------
void Terminal::run()
{
    // init var
    char * line = NULL;

    // loop
    while(_again)
    {
        update_prompt();
        line = readline(_prompt.c_str());
        
        free (line);
    }
}

//==============================================================================
//
// Private methods
//
//==============================================================================
//------------------------------------------------------------------------------
// update_prompt
//------------------------------------------------------------------------------
void Terminal::update_prompt()
{
    time_t rawtime;
    struct tm * timeinfo;
    char buffer[80];

    time (&rawtime);
    timeinfo = localtime(&rawtime);

    strftime(buffer,80,"%I:%M:%S",timeinfo);
    std::string str(buffer);

    _prompt = "dominus_monitor_cmd-";
    _prompt.append(str);
    _prompt.append(" # ");
}

//------------------------------------------------------------------------------
// init_completion
//------------------------------------------------------------------------------
void Terminal::init_completion()
{
  rl_readline_name = _name.c_str();
  rl_attempted_completion_function = search_completion;
}

//==============================================================================
//
// Functions
//
//==============================================================================
//------------------------------------------------------------------------------
// search_completion
//------------------------------------------------------------------------------
// return a list of char* where 1 element is a command begining with 'text'
char ** search_completion(const char * text, int start, int end)
{
  char **matches = (char**) NULL;

  if(start==0)
      printf("coucou\n");
      
  return matches;
}
